<!-- === New England Transit: Live Statistics (v2) === -->
<style>
  :root{
    --bg:#ffffff; --fg:#0a0a0a; --muted:#50565c;
    --card:#ffffff; --bd:rgba(0,0,0,.12); --accent:#ff7f00;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --fg:#e8eefc; --muted:#b8c2e0;
    --card:#121832; --bd:rgba(255,255,255,.14); --accent:#ff7f00;
  }

  .net-wrap{max-width:1100px;margin:24px auto;padding:0 16px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg)}
  .net-eyebrow{font-size:.9rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
  .net-h1{font-size:clamp(24px,3.2vw,40px);margin:.25rem 0 1rem;font-weight:800}
  .net-lead{opacity:.85;margin:.25rem 0 1rem;color:var(--muted)}
  .net-card{border:1px solid var(--bd);border-radius:12px;padding:12px;margin-top:10px;background:var(--card)}
  .net-hint{font-size:.9rem;color:var(--muted)}
  .net-controls,.net-filters,.net-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  .net-bar{justify-content:space-between}
  .net-table{border-top:1px solid var(--bd);margin-top:8px}
  .net-row,.net-head{display:grid;grid-template-columns:1.1fr .7fr .6fr .7fr .7fr .5fr;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid var(--bd)}
  .net-head{font-weight:700;border-bottom:2px solid var(--bd)}
  .net-id{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid var(--bd);cursor:pointer;background:var(--accent);color:#0b0b0b;font-weight:700}
  .btn.ghost{background:transparent;color:var(--fg)}
  .btn:active{transform:translateY(1px)}
  input[type=number],input[type=text],select{
    padding:8px 10px;border-radius:8px;border:1px solid var(--bd);background:transparent;color:var(--fg)
  }
  input::placeholder{color:var(--muted)}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--bd);border-radius:999px;font-size:.9rem}
  .net-actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;padding:10px 0}
  .theme-toggle{border:1px solid var(--bd);border-radius:8px;padding:6px 10px;background:transparent;color:var(--fg);cursor:pointer}

  /* Auto-refresh pulse */
  @keyframes netPulse{0%{box-shadow:0 0 0 0 rgba(255,127,0,.0)}50%{box-shadow:0 0 0 6px rgba(255,127,0,.15)}100%{box-shadow:0 0 0 0 rgba(255,127,0,0)}}
  .updating{animation:netPulse .6s ease-out 1}

  /* Mobile cards */
  @media (max-width:760px){
    .net-row,.net-head{grid-template-columns:1fr}
    .net-head{display:none}
    .net-row{border:1px solid var(--bd);border-radius:10px;padding:12px;background:var(--card)}
    .net-row > div{display:flex;justify-content:space-between;padding:4px 0}
    .net-row .net-join{justify-content:flex-end}
  }

  /* Page background */
  .net-bg{background:var(--bg)}
</style>

<section class="net-wrap net-bg" id="net-live" data-theme="">
  <div class="net-bar">
    <div>
      <div class="net-eyebrow">Live Transit Dashboard</div>
      <h1 class="net-h1">New England Transit: Live Statistics</h1>
      <p class="net-lead">Real-time Roblox activity for Public servers.</p>
    </div>
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">üåô/‚òÄÔ∏è</button>
  </div>

  <div class="net-card" id="net-summary">
    <strong>Universe Players:</strong> <span id="uPlayers">‚Äì</span> ‚Ä¢
    <strong>Servers Shown:</strong> <span id="srvShown">‚Äì</span> ‚Ä¢
    <strong>Players in Shown:</strong> <span id="srvPlayers">‚Äì</span> ‚Ä¢
    <strong>Peak:</strong> <span id="peakVal">‚Äì</span> <span class="net-hint" id="peakWhen"></span>
    <div class="net-hint">Auto-updates every 15s ‚Ä¢ Peak is saved locally in your browser</div>
  </div>

  <!-- Place selector + Search -->
  <div class="net-controls">
    <label for="net-place">Place:&nbsp;</label>
    <select id="net-place">
      <option value="79519172222138">Lower Mystic (Public)</option>
      <option value="8731366500">Hub / Starting Place (Public)</option>
    </select>

    <label>Search:
      <input id="flt-search" type="text" placeholder="Search server id or region‚Ä¶">
    </label>
  </div>

  <!-- Filters -->
  <div class="net-filters">
    <label>Region:
      <select id="flt-region">
        <option value="">All</option>
      </select>
    </label>
    <label>Min FPS:
      <input id="flt-fps" type="number" step="1" min="0" placeholder="0">
    </label>
    <label class="chip">
      <input id="flt-nonempty" type="checkbox"> Only non-empty
    </label>
    <button id="flt-reset" class="btn ghost">Reset filters</button>
  </div>

  <div class="net-card" id="net-card-table">
    <div class="net-head">
      <div>Server</div><div>Players</div><div>FPS</div><div>Region</div><div>Uptime</div><div></div>
    </div>
    <div id="net-table" class="net-table">Loading servers‚Ä¶</div>

    <!-- Fallback banner (shown only if deep link fails) -->
    <div id="net-fallback" style="display:none;margin-top:8px"></div>

    <div class="net-actions">
      <span class="net-hint" id="net-pagehint"></span>
      <button id="net-load" class="btn ghost" style="display:none">Load more</button>
      <button id="net-loadall" class="btn ghost" style="display:none">Load all</button>
    </div>
  </div>
</section>

<script>
  // ===== Config =====
  const WORKER_BASE = "https://live.contact-b46.workers.dev";
  const UNIVERSE_ID = "8731366500";      // Universe
  const SERVER_TYPE = "Public";
  const JOIN_OPEN_NEW_TAB = false;       // web fallback opens in same tab by default

  // ===== Elements =====
  const rootEl       = document.getElementById("net-live");
  const themeBtn     = document.getElementById("themeToggle");
  const placeSelect  = document.getElementById("net-place");
  const tableEl      = document.getElementById("net-table");
  const cardTableEl  = document.getElementById("net-card-table");
  const uPlayersEl   = document.getElementById("uPlayers");
  const srvShownEl   = document.getElementById("srvShown");
  const srvPlayersEl = document.getElementById("srvPlayers");
  const peakValEl    = document.getElementById("peakVal");
  const peakWhenEl   = document.getElementById("peakWhen");
  const loadBtn      = document.getElementById("net-load");
  const loadAllBtn   = document.getElementById("net-loadall");
  const pageHint     = document.getElementById("net-pagehint");
  const fltRegion    = document.getElementById("flt-region");
  const fltFPS       = document.getElementById("flt-fps");
  const fltNonEmpty  = document.getElementById("flt-nonempty");
  const fltReset     = document.getElementById("flt-reset");
  const fltSearch    = document.getElementById("flt-search");
  const fallbackBox  = document.getElementById("net-fallback");
  const summaryEl    = document.getElementById("net-summary");

  // ===== Theme (auto + toggle) =====
  const savedTheme = localStorage.getItem("net-theme");
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  setTheme(savedTheme || (prefersDark ? "dark" : "light"));
  themeBtn.addEventListener("click", ()=> setTheme(rootEl.dataset.theme === "dark" ? "light" : "dark"));
  function setTheme(mode){
    rootEl.dataset.theme = mode;
    localStorage.setItem("net-theme", mode);
  }

  // ===== State =====
  let currentPlaceId = placeSelect.value;
  let items = [];         // accumulated raw servers
  let nextCursor = null;  // pagination cursor
  let loading = false;

  // Filters state
  const filters = { region: "", minFps: 0, nonEmpty: false, search: "" };

  // Peak tracker (local)
  const PEAK_KEY = "net_peak_universe";
  const peakStore = JSON.parse(localStorage.getItem(PEAK_KEY) || "{}"); // {val, whenISO}
  if (peakStore.val) {
    peakValEl.textContent = peakStore.val;
    peakWhenEl.textContent = `(${new Date(peakStore.whenISO).toLocaleString()})`;
  }

  // ===== API =====
  async function fetchSummary(placeId) {
    const url = `${WORKER_BASE}/api/summary?universeId=${UNIVERSE_ID}&placeId=${placeId}&serverType=${SERVER_TYPE}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
  }
  async function fetchServers(placeId, cursor = "") {
    const url = new URL(`${WORKER_BASE}/api/servers`);
    url.searchParams.set("placeId", placeId);
    url.searchParams.set("serverType", SERVER_TYPE);
    if (cursor) url.searchParams.set("cursor", cursor);
    const res = await fetch(url.toString(), { cache: "no-store" });
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json(); // { items, nextPageCursor }
  }

  // ===== Join (deep link same tab + manual fallback) =====
  function showFallback(jobId, placeId) {
    const web = `https://www.roblox.com/games/start?placeId=${placeId}&gameInstanceId=${jobId}`;
    fallbackBox.innerHTML = `
      <div style="border:1px solid var(--bd);border-radius:10px;padding:10px">
        Having trouble launching Roblox?
        <button class="btn ghost" id="net-open-web">Open via web launcher</button>
      </div>`;
    fallbackBox.style.display = "block";
    document.getElementById("net-open-web").onclick = () => {
      if (JOIN_OPEN_NEW_TAB) window.open(web, "_blank", "noopener"); else window.location.href = web;
    };
  }
  function hideFallback(){ fallbackBox.style.display="none"; fallbackBox.innerHTML=""; }
  function joinServer(placeId, jobId) {
    hideFallback();
    const deep = `roblox://placeId=${placeId}&gameInstanceId=${jobId}`;
    let opened = false;
    const onVisibility = () => { if (document.hidden) { opened = true; cleanup(); } };
    const onPageHide = () => { opened = true; cleanup(); };
    function cleanup(){ document.removeEventListener("visibilitychange", onVisibility); window.removeEventListener("pagehide", onPageHide); }
    document.addEventListener("visibilitychange", onVisibility, { once:true });
    window.addEventListener("pagehide", onPageHide, { once:true });
    window.location.assign(deep);
    setTimeout(()=>{ if (!opened && !document.hidden) showFallback(jobId, placeId); cleanup(); }, 1000);
  }
  window.joinServer = joinServer;

  // ===== Utils =====
  function applyFilters(list){
    const q = filters.search.trim().toLowerCase();
    return list.filter(s=>{
      if (filters.region && (s.region ?? "") !== filters.region) return false;
      const fpsVal = (typeof s.fps === "number") ? s.fps : 0;
      if (filters.minFps && fpsVal < filters.minFps) return false;
      if (filters.nonEmpty && (!s.playing || s.playing <= 0)) return false;
      if (q){
        const id = (s.id||"").toLowerCase();
        const region = (s.region||"").toLowerCase();
        if (!id.includes(q) && !region.includes(q)) return false;
      }
      return true;
    });
  }
  function populateRegionFilter(list){
    const uniq = Array.from(new Set(list.map(s=>s.region).filter(Boolean))).sort();
    const cur = fltRegion.value;
    fltRegion.innerHTML = `<option value="">All</option>` + uniq.map(r=>`<option value="${r}">${r}</option>`).join("");
    if (uniq.includes(cur)) fltRegion.value = cur;
  }
  function fmtUptime(createdISO){
    if (!createdISO) return "‚Äì";
    const ms = Date.now() - new Date(createdISO).getTime();
    if (ms < 0) return "‚Äì";
    const s = Math.floor(ms/1000), m = Math.floor(s/60), h = Math.floor(m/60);
    if (h >= 24) return `${Math.floor(h/24)}d ${h%24}h`;
    if (h > 0) return `${h}h ${m%60}m`;
    return `${m}m ${s%60}s`;
  }

  // ===== Render =====
  function pulse(el){ el.classList.add("updating"); setTimeout(()=>el.classList.remove("updating"), 600); }

  function renderSummary(playersUniverse){
    const filtered = applyFilters(items);
    srvShownEl.textContent   = filtered.length;
    srvPlayersEl.textContent = filtered.reduce((n,s)=>n+(s.playing??0),0);

    if (typeof playersUniverse === "number") {
      uPlayersEl.textContent = playersUniverse;
      // Peak tracker
      const prev = Number(peakStore.val || 0);
      if (playersUniverse > prev){
        const when = new Date().toISOString();
        localStorage.setItem(PEAK_KEY, JSON.stringify({ val: playersUniverse, whenISO: when }));
        peakValEl.textContent = playersUniverse;
        peakWhenEl.textContent = `(${new Date(when).toLocaleString()})`;
      } else {
        peakValEl.textContent = peakStore.val ?? "‚Äì";
        peakWhenEl.textContent = peakStore.whenISO ? `(${new Date(peakStore.whenISO).toLocaleString()})` : "";
      }
    }
  }

  function renderServers(listRaw=[]){
    const list = applyFilters(listRaw);

    if (!listRaw.length){
      tableEl.textContent = "No public servers found.";
      loadBtn.style.display = "none";
      loadAllBtn.style.display = "none";
      pageHint.textContent = "";
      return;
    }

    // Desktop table
    const rows = list.map(s=>{
      const players = `${s.playing ?? 0} / ${s.maxPlayers ?? "?"}`;
      const fps = (typeof s.fps === "number") ? s.fps.toFixed(0) : "‚Äì";
      const region = s.region ?? "‚Äì";
      const uptime = fmtUptime(s.created);
      const created = s.created ? new Date(s.created).toLocaleTimeString() : "";
      const id = s.id || "";
      return `
        <div class="net-row">
          <div><span class="net-id">${id.slice(0,8)}‚Ä¶</span><br><small>${created}</small></div>
          <div>${players}</div>
          <div>${fps}</div>
          <div>${region}</div>
          <div>${uptime}</div>
          <div class="net-join"><button class="btn" onclick="joinServer('${currentPlaceId}','${id}')">Join</button></div>
        </div>`;
    }).join("");
    tableEl.innerHTML = rows;

    const hasMore = !!nextCursor;
    loadBtn.style.display = hasMore ? "inline-flex" : "none";
    loadAllBtn.style.display = hasMore ? "inline-flex" : "none";
    pageHint.textContent = hasMore ? "More servers available" : "All servers loaded";
  }

  // ===== Bootstrapping & polling =====
  async function bootstrapFirstPage(){
    try{
      loading = true;
      tableEl.textContent = "Loading servers‚Ä¶";
      const summary = await fetchSummary(currentPlaceId);
      pulse(summaryEl);
      const playersUniverse = summary.playersUniverse ?? null;

      items = Array.isArray(summary.servers) ? summary.servers : [];
      nextCursor = summary.nextCursor || null;

      populateRegionFilter(items);
      renderSummary(playersUniverse);
      renderServers(items);
    }catch(e){
      console.error(e);
      tableEl.textContent = "Error loading stats.";
      loadBtn.style.display = loadAllBtn.style.display = "none";
      pageHint.textContent = "";
    }finally{ loading = false; }
  }

  async function pollFirstPage(){
    if (loading) return;
    try{
      const summary = await fetchSummary(currentPlaceId);
      pulse(summaryEl);
      const playersUniverse = summary.playersUniverse ?? null;

      const first = Array.isArray(summary.servers) ? summary.servers : [];
      const map = new Map(items.map(i=>[i.id,i]));
      first.forEach(i=>map.set(i.id,i));
      items = Array.from(map.values());
      nextCursor = summary.nextCursor || nextCursor;

      populateRegionFilter(items);
      renderSummary(playersUniverse);
      renderServers(items);
    }catch(e){ /* ignore one-off */ }
  }

  // ===== Events =====
  placeSelect.addEventListener("change", ()=>{
    currentPlaceId = placeSelect.value;
    items = []; nextCursor = null;
    renderSummary(); renderServers(items);
    bootstrapFirstPage();
  });

  loadBtn.addEventListener("click", async ()=>{
    if (!nextCursor || loading) return;
    try{
      loading = true; loadBtn.textContent = "Loading‚Ä¶";
      const page = await fetchServers(currentPlaceId, nextCursor);
      const newItems = Array.isArray(page.items)?page.items:[];
      nextCursor = page.nextPageCursor || null;
      const existing = new Set(items.map(i=>i.id));
      newItems.forEach(i=>{ if(!existing.has(i.id)) items.push(i); });
      populateRegionFilter(items);
      renderSummary(); renderServers(items);
    }catch(e){ console.error(e); pageHint.textContent = "Error loading more."; }
    finally{ loadBtn.textContent = "Load more"; loading = false; }
  });

  loadAllBtn.addEventListener("click", async ()=>{
    if (loading) return;
    try{
      loading = true; loadAllBtn.textContent = "Loading all‚Ä¶";
      while(nextCursor){
        const page = await fetchServers(currentPlaceId, nextCursor);
        const newItems = Array.isArray(page.items)?page.items:[];
        nextCursor = page.nextPageCursor || null;
        const existing = new Set(items.map(i=>i.id));
        newItems.forEach(i=>{ if(!existing.has(i.id)) items.push(i); });
      }
      populateRegionFilter(items);
      renderSummary(); renderServers(items);
    }catch(e){ console.error(e); pageHint.textContent = "Error loading all."; }
    finally{ loadAllBtn.textContent = "Load all"; loading = false; }
  });

  function onFilterChange(){
    filters.region = fltRegion.value;
    filters.minFps = Number(fltFPS.value || 0);
    filters.nonEmpty = fltNonEmpty.checked;
    filters.search = fltSearch.value || "";
    renderSummary(); renderServers(items);
  }
  fltRegion.addEventListener("change", onFilterChange);
  fltFPS.addEventListener("input", onFilterChange);
  fltNonEmpty.addEventListener("change", onFilterChange);
  fltReset.addEventListener("click", ()=>{ fltRegion.value=""; fltFPS.value=""; fltNonEmpty.checked=false; fltSearch.value=""; onFilterChange(); });
  fltSearch.addEventListener("input", onFilterChange);

  // Start
  bootstrapFirstPage();
  setInterval(pollFirstPage, 15000);
</script>
<!-- === /NET Live v2 === -->
