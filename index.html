<!-- === New England Transit: Live Statistics (drop-in) === -->
<style>
  /* minimal styles so it looks OK even without your site CSS */
  .net-wrap{max-width:1100px;margin:24px auto;padding:0 16px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .net-eyebrow{font-size:.9rem;opacity:.7;letter-spacing:.12em;text-transform:uppercase}
  .net-h1{font-size:clamp(24px,3.2vw,40px);margin:.25rem 0 1rem;font-weight:800}
  .net-lead{color:#333;opacity:.9;margin:.25rem 0 1rem}
  .net-card{border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;margin-top:10px}
  .net-hint{font-size:.9rem;opacity:.7}
  .net-controls{margin:12px 0}
  .net-table{border-top:1px solid rgba(0,0,0,.15);margin-top:8px}
  .net-row,.net-head{display:grid;grid-template-columns:1.4fr .8fr .6fr .8fr .6fr;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.08)}
  .net-head{font-weight:700;border-bottom:2px solid rgba(0,0,0,.25)}
  .net-id{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.15);cursor:pointer;background:#ff7f00;color:#0b0b0b;font-weight:700}
  .btn:active{transform:translateY(1px)}
  @media (max-width:760px){ .net-row,.net-head{grid-template-columns:1.6fr .8fr .6fr .8fr 1fr} }
</style>

<section class="net-wrap" id="net-live">
  <div class="net-eyebrow">Live Transit Dashboard</div>
  <h1 class="net-h1">New England Transit: Live Statistics</h1>
  <p class="net-lead">Real-time Roblox activity across our places. Public servers only.</p>

  <div class="net-card" id="net-summary">
    <strong>Universe Players:</strong> <span id="uPlayers">–</span> •
    <strong>Servers Listed:</strong> <span id="srvCount">–</span> •
    <strong>Players in Listed:</strong> <span id="srvPlayers">–</span>
    <div class="net-hint">Auto-updates every 15s</div>
  </div>

  <div class="net-controls">
    <label for="net-place">Place:&nbsp;</label>
    <select id="net-place">
      <option value="79519172222138">Lower Mystic (Public)</option>
      <!-- Add more places when ready:
      <option value="HUB_PLACE_ID">Main Hub (Public)</option>
      -->
    </select>
  </div>

  <div class="net-card">
    <div class="net-head">
      <div>Server</div><div>Players</div><div>FPS</div><div>Region</div><div></div>
    </div>
    <div id="net-table" class="net-table">Loading servers…</div>
  </div>
</section>

<script>
  // ====== Config ======
  const WORKER_BASE = "https://live.contact-b46.workers.dev"; // your Cloudflare Worker
  const UNIVERSE_ID = "8731366500";
  const SERVER_TYPE = "Public";

  // ====== Elements ======
  const placeSelect = document.getElementById("net-place");
  const tableEl = document.getElementById("net-table");
  const uPlayersEl = document.getElementById("uPlayers");
  const srvCountEl = document.getElementById("srvCount");
  const srvPlayersEl = document.getElementById("srvPlayers");

  // Track current place in view (for Join buttons)
  let currentPlaceId = placeSelect.value;
  placeSelect.addEventListener("change", () => {
    currentPlaceId = placeSelect.value;
    tick();
  });

  // ====== API calls ======
  async function fetchSummary(placeId) {
    const url = `${WORKER_BASE}/api/summary?universeId=${UNIVERSE_ID}&placeId=${placeId}&serverType=${SERVER_TYPE}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
  }

  // ====== Join button handler ======
  function joinServer(placeId, jobId) {
    // Try Roblox app deep link, fallback to web launcher
    const deep = `roblox://placeId=${placeId}&gameInstanceId=${jobId}`;
    const web  = `https://www.roblox.com/games/start?placeId=${placeId}&gameInstanceId=${jobId}`;
    const t = Date.now();
    const iframe = document.createElement("iframe");
    iframe.style.display = "none";
    iframe.src = deep;
    document.body.appendChild(iframe);
    setTimeout(() => {
      if (Date.now() - t < 1200) window.open(web, "_blank", "noopener");
      document.body.removeChild(iframe);
    }, 900);
  }

  // ====== Render ======
  function renderServers(items = []) {
    if (!items.length) { tableEl.textContent = "No public servers found."; return; }

    const rows = items.map(s => {
      const players = `${s.playing ?? 0} / ${s.maxPlayers ?? "?"}`;
      const fps = (typeof s.fps === "number") ? s.fps.toFixed(0) : "–";
      const region = s.region ?? "–";
      const created = s.created ? new Date(s.created).toLocaleTimeString() : "";
      const id = s.id || "";
      return `
        <div class="net-row">
          <div><span class="net-id">${id.slice(0,8)}…</span><br><small>${created}</small></div>
          <div>${players}</div>
          <div>${fps}</div>
          <div>${region}</div>
          <div><button class="btn" onclick="joinServer('${currentPlaceId}','${id}')">Join</button></div>
        </div>`;
    }).join("");

    tableEl.innerHTML = rows;
  }

  // ====== Tick loop ======
  async function tick() {
    try {
      const data = await fetchSummary(currentPlaceId);
      uPlayersEl.textContent = data.playersUniverse ?? "–";
      srvCountEl.textContent = data.serversListed ?? "–";
      srvPlayersEl.textContent = data.playersInListedServers ?? "–";
      renderServers(data.servers || []);
    } catch (err) {
      console.error(err);
      tableEl.textContent = "Error loading stats.";
    }
  }
  tick();
  setInterval(tick, 15000);

  // expose for inline onclick
  window.joinServer = joinServer;
</script>
<!-- === /NET Live block === -->
