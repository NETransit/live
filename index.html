<section class="hero">
  <div class="container hero-wrap">
    <div class="copy">
      <div class="eyebrow">Live Transit Dashboard</div>
      <h1>New England Transit: Live Statistics</h1>
      <p class="lead">Real-time Roblox activity across our places. Public servers only.</p>

      <div id="liveStats" class="card" style="margin-top:16px">
        <strong>Universe Players:</strong> <span id="uPlayers">–</span> •
        <strong>Servers Listed:</strong> <span id="srvCount">–</span> •
        <strong>Players in Listed:</strong> <span id="srvPlayers">–</span>
        <div class="hint">Auto-updates every 15s</div>
      </div>

      <div style="margin-top:10px">
        <label for="place">Place:</label>
        <select id="place">
          <option value="79519172222138">Lower Mystic (Public)</option>
          <!-- If/when you have the Hub's true placeId, add it here -->
          <!-- <option value="HUB_PLACE_ID">Main Hub (Public)</option> -->
        </select>
      </div>
    </div>

    <div class="media">
      <div class="browser-frame">
        <div class="browser-chrome"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
        <div class="frame-body">
          <div id="serverTable">Loading servers…</div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const WORKER_BASE = "https://live.contact-b46.workers.dev";
const UNIVERSE_ID = "8731366500";
const SERVER_TYPE = "Public";
const placeSelect = document.getElementById("place");

async function fetchSummary(placeId) {
  const url = `${WORKER_BASE}/api/summary?universeId=${UNIVERSE_ID}&placeId=${placeId}&serverType=${SERVER_TYPE}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("API error");
  return res.json();
}

function renderServers(items = []) {
  if (!items.length) {
    document.getElementById("serverTable").innerHTML = "No public servers found.";
    return;
  }
  const header = `<div style="display:grid;grid-template-columns:1.2fr .6fr .6fr .6fr;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.12);font-weight:700">
      <div>Server</div><div>Players</div><div>FPS</div><div>Region</div>
    </div>`;
  const rows = items.map(s => {
    const players = `${s.playing ?? 0} / ${s.maxPlayers ?? "?"}`;
    const fps = (typeof s.fps === "number") ? s.fps.toFixed(0) : "–";
    const region = s.region ?? "–";
    const created = s.created ? new Date(s.created).toLocaleTimeString() : "";
    return `<div style="display:grid;grid-template-columns:1.2fr .6fr .6fr .6fr;gap:8px;padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">
      <div><strong>${(s.id || "").slice(0,8)}…</strong><br><small>${created}</small></div>
      <div>${players}</div>
      <div>${fps}</div>
      <div>${region}</div>
    </div>`;
  }).join("");
  document.getElementById("serverTable").innerHTML = header + rows;
}

async function tick() {
  const placeId = placeSelect.value;
  try {
    const data = await fetchSummary(placeId);
    document.getElementById("uPlayers").textContent = data.playersUniverse ?? "–";
    document.getElementById("srvCount").textContent = data.serversListed ?? "–";
    document.getElementById("srvPlayers").textContent = data.playersInListedServers ?? "–";
    renderServers(data.servers || []);
  } catch (e) {
    document.getElementById("serverTable").textContent = "Error loading stats.";
    console.error(e);
  }
}
placeSelect.addEventListener("change", tick);
tick();
setInterval(tick, 15000);
</script>
